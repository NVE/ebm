parameters:
  - name: remote_branch
    type: string
    default: '$(Build.SourceBranchName)'
  - name: git_user_email
    type: string
    default: 'ebm@nve.no'

steps:
  - script: |
      echo "ğŸŒ² ${{ parameters.remote_branch }} $(GITHUB_REPO)" 
      git remote add github https://$(GITHUB_TOKEN)@$(GITHUB_REPO)
    displayName: 'Add remote ğŸ”­'
  - script: |
      git fetch github +refs/heads/${{ parameters.remote_branch }}:refs/remotes/github/${{ parameters.remote_branch }}
    displayName: 'Fetch remote ğŸ“¥'

  - script: git checkout -B ${{ parameters.remote_branch }}
    displayName: "Switch to ${{ parameters.remote_branch }} ğŸŒ³"
  - script: |
      HEAD_COMMIT=$(git log -1 --oneline)
      REMOTE_COMMIT=$(git log github/${{ parameters.remote_branch }} -1 --oneline)
      echo "ğŸ” HEAD latest commit: $(HEAD_COMMIT)"
      echo "ğŸ” Remote branch latest commit: $(REMOTE_COMMIT)"
    displayName: 'Check commits ğŸ“–'

  - script: |
      # Check for divergence
      if ! git merge-base --is-ancestor github/${{ parameters.remote_branch }} HEAD; then
        echo "âš ï¸ Divergence detected: remote has commits not found locally."
        echo "ğŸ•µï¸ Remote commits:"
        git log HEAD..github/${{ parameters.remote_branch }} --oneline
        echo "ğŸ³ï¸ Refusing to force push"
        exit 1
      fi
      echo "ğŸ Safe to force push."
    displayName: 'Divergence check ğŸ›‚'
  - script: git push --force github HEAD:${{ parameters.remote_branch }}
    displayName: 'Force push ğŸ¤œ'

    env:
      GITHUB_TOKEN: $(GITHUB_TOKEN)
      GITHUB_REPO: $(GITHUB_REPO)
      REMOTE_BRANCH: ${{parameters.remote_branch}}
